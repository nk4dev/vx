<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>カスタムGUIデバッグツール</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Noto+Sans+JP:wght@400;500;600&display=swap"
        rel="stylesheet">
    <style>
        /* カスタムフォントの設定 */
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }

        /* デバッグツールのコンテナ */
        #debug-tool {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9999;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        }

        /* 非表示時のスタイル */
        #debug-tool.hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
        }

        /* ドラッグハンドルのカーソル */
        #debug-header {
            cursor: move;
        }

        /* スクロールバーのスタイル */
        .debug-content::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .debug-content::-webkit-scrollbar-track {
            background: #2d3748;
            /* bg-gray-800 */
        }

        .debug-content::-webkit-scrollbar-thumb {
            background: #4a5568;
            /* bg-gray-600 */
            border-radius: 3px;
        }

        .debug-content::-webkit-scrollbar-thumb:hover {
            background: #718096;
            /* bg-gray-500 */
        }
    </style>
</head>

<body class="bg-gray-100 p-8">

    <h1 class="text-3xl font-bold mb-4 text-gray-800">アプリケーションのメインコンテンツ</h1>
    <p class="text-gray-600 mb-4">このページにカスタムデバッグツールが組み込まれています。</p>
    <p class="text-gray-600 mb-2">ショートカット: `Ctrl + D` でデバッグツールの表示/非表示を切り替えられます。</p>
    <div class="space-x-2">
        <button id="test-log-btn"
            class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75">テストログ出力</button>
        <button id="test-error-btn"
            class="px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75">テストエラー出力</button>
        <button id="change-var-btn"
            class="px-4 py-2 bg-green-500 text-white font-semibold rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">監視対象の変数を変更</button>
    </div>


    <!-- カスタムGUIデバッグツール -->
    <div id="debug-tool" class="w-96 max-w-full bg-gray-800 text-white rounded-lg border border-gray-700">
        <!-- ヘッダー -->
        <div id="debug-header"
            class="flex items-center justify-between p-3 bg-gray-900 rounded-t-lg border-b border-gray-700">
            <h2 class="text-lg font-bold">デバッグツール</h2>
            <button id="toggle-debug-tool" class="text-gray-400 hover:text-white">&times;</button>
        </div>

        <!-- タブ -->
        <div class="p-2 bg-gray-800">
            <div class="flex space-x-1">
                <button class="debug-tab-btn active w-full px-3 py-1 text-sm font-medium rounded-md"
                    data-tab="logs">ログ</button>
                <button class="debug-tab-btn w-full px-3 py-1 text-sm font-medium rounded-md"
                    data-tab="watches">変数監視</button>
                <button class="debug-tab-btn w-full px-3 py-1 text-sm font-medium rounded-md"
                    data-tab="actions">操作</button>
            </div>
        </div>

        <!-- コンテンツエリア -->
        <div class="debug-content h-80 overflow-y-auto p-3">
            <!-- ログパネル -->
            <div id="logs-panel" class="debug-tab-content">
                <!-- ログがここに追加されます -->
            </div>
            <!-- 変数監視パネル -->
            <div id="watches-panel" class="debug-tab-content hidden">
                <!-- 監視対象の変数がここに追加されます -->
            </div>
            <!-- 操作パネル -->
            <div id="actions-panel" class="debug-tab-content hidden space-y-2">
                <!-- カスタムボタンがここに追加されます -->
            </div>
        </div>
    </div>

    <script>
        class DebugTool {
            constructor() {
                // --- DOM要素の取得 ---
                this.toolElement = document.getElementById('debug-tool');
                this.headerElement = document.getElementById('debug-header');
                this.closeButton = document.getElementById('toggle-debug-tool');
                this.logPanel = document.getElementById('logs-panel');
                this.watchPanel = document.getElementById('watches-panel');
                this.actionPanel = document.getElementById('actions-panel');
                this.tabs = document.querySelectorAll('.debug-tab-btn');
                this.tabContents = document.querySelectorAll('.debug-tab-content');

                // --- 状態変数 ---
                this.isDragging = false;
                this.isVisible = true;
                this.position = { x: 20, y: 20 };
                this.dragStart = { x: 0, y: 0 };
                this.watchedVars = {}; // 監視対象の変数を格納するオブジェクト

                // --- 初期化処理 ---
                this.init();
            }

            /**
             * ツールの初期化
             */
            init() {
                // ドラッグ機能の有効化
                this.makeDraggable();

                // 表示/非表示の切り替えイベント
                this.closeButton.addEventListener('click', () => this.toggleVisibility());
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.key === 'd') {
                        e.preventDefault();
                        this.toggleVisibility();
                    }
                });

                // タブ切り替え機能の有効化
                this.tabs.forEach(tab => {
                    tab.addEventListener('click', () => this.switchTab(tab.dataset.tab));
                });
                this.switchTab('logs'); // 初期タブ

                // consoleをオーバーライドしてログをキャプチャ
                this.overrideConsole();

                // 変数監視のループを開始
                this.updateWatchLoop();
            }

            /**
             * ツールをドラッグ可能にする
             */
            makeDraggable() {
                this.headerElement.addEventListener('mousedown', (e) => {
                    this.isDragging = true;
                    this.dragStart.x = e.clientX - this.position.x;
                    this.dragStart.y = e.clientY - this.position.y;
                    // ドラッグ中のテキスト選択を無効化
                    document.body.style.userSelect = 'none';
                });

                document.addEventListener('mousemove', (e) => {
                    if (!this.isDragging) return;
                    this.position.x = e.clientX - this.dragStart.x;
                    this.position.y = e.clientY - this.dragStart.y;
                    // 画面外にはみ出さないように制限
                    this.position.x = Math.max(0, Math.min(this.position.x, window.innerWidth - this.toolElement.offsetWidth));
                    this.position.y = Math.max(0, Math.min(this.position.y, window.innerHeight - this.toolElement.offsetHeight));

                    this.toolElement.style.left = `${this.position.x}px`;
                    this.toolElement.style.top = `${this.position.y}px`;
                });

                document.addEventListener('mouseup', () => {
                    this.isDragging = false;
                    document.body.style.userSelect = '';
                });
            }

            /**
             * ツールの表示/非表示を切り替える
             */
            toggleVisibility() {
                this.isVisible = !this.isVisible;
                this.toolElement.classList.toggle('hidden', !this.isVisible);
            }

            /**
             * タブを切り替える
             * @param {string} tabName - 'logs', 'watches', 'actions'
             */
            switchTab(tabName) {
                this.tabs.forEach(tab => {
                    tab.classList.toggle('active', tab.dataset.tab === tabName);
                    // Tailwind CSS を使ってアクティブ/非アクティブのスタイルを変更
                    if (tab.dataset.tab === tabName) {
                        tab.classList.add('bg-blue-500', 'text-white');
                        tab.classList.remove('text-gray-300', 'hover:bg-gray-700');
                    } else {
                        tab.classList.remove('bg-blue-500', 'text-white');
                        tab.classList.add('text-gray-300', 'hover:bg-gray-700');
                    }
                });
                this.tabContents.forEach(content => {
                    content.classList.toggle('hidden', content.id !== `${tabName}-panel`);
                });
            }

            /**
             * console.logなどをオーバーライドしてGUIに表示する
             */
            overrideConsole() {
                const originalLog = console.log;
                const originalError = console.error;
                const originalWarn = console.warn;
                const self = this;

                console.log = function (...args) {
                    self.addLog('log', args);
                    originalLog.apply(console, args);
                };
                console.error = function (...args) {
                    self.addLog('error', args);
                    originalError.apply(console, args);
                };
                console.warn = function (...args) {
                    self.addLog('warn', args);
                    originalWarn.apply(console, args);
                };
            }

            /**
             * ログパネルにメッセージを追加する
             * @param {string} type - 'log', 'error', 'warn'
             * @param {Array} args - ログに出力する内容
             */
            addLog(type, args) {
                const logEntry = document.createElement('div');
                const timestamp = new Date().toLocaleTimeString();
                let colorClass = 'text-gray-300';
                if (type === 'error') colorClass = 'text-red-400';
                if (type === 'warn') colorClass = 'text-yellow-400';

                // オブジェクトや配列を整形して表示
                const message = args.map(arg => {
                    if (typeof arg === 'object' && arg !== null) {
                        try {
                            return JSON.stringify(arg, null, 2);
                        } catch (e) {
                            return '[Circular Object]';
                        }
                    }
                    return String(arg);
                }).join(' ');

                logEntry.innerHTML = `
                <div class="flex items-start text-sm font-mono ${colorClass} border-b border-gray-700 py-1">
                    <span class="mr-2 text-gray-500">${timestamp}</span>
                    <pre class="whitespace-pre-wrap break-all">${message}</pre>
                </div>
            `;
                this.logPanel.appendChild(logEntry);
                // 自動で一番下にスクロール
                this.logPanel.scrollTop = this.logPanel.scrollHeight;
            }

            /**
             * 変数を監視リストに追加する
             * @param {string} name - 変数名
             * @param {Function} getter - 変数の値を取得する関数
             */
            watch(name, getter) {
                if (typeof getter !== 'function') {
                    console.error(`Watcher for "${name}" must be a function.`);
                    return;
                }
                this.watchedVars[name] = { getter, element: null };
                this.renderWatchPanel();
            }

            /**
             * 変数監視パネルを再描画する
             */
            renderWatchPanel() {
                this.watchPanel.innerHTML = '';
                for (const name in this.watchedVars) {
                    const watchEntry = document.createElement('div');
                    watchEntry.className = 'flex justify-between items-center text-sm font-mono p-1 bg-gray-700 rounded mb-1';
                    watchEntry.innerHTML = `
                    <span class="text-blue-300">${name}:</span>
                    <span class="value-display text-green-300"></span>
                `;
                    this.watchPanel.appendChild(watchEntry);
                    this.watchedVars[name].element = watchEntry.querySelector('.value-display');
                }
                this.updateWatchValues();
            }

            /**
             * 監視している変数の値を更新する
             */
            updateWatchValues() {
                for (const name in this.watchedVars) {
                    if (this.watchedVars[name].element) {
                        try {
                            const value = this.watchedVars[name].getter();
                            let displayValue = value;
                            if (typeof value === 'object' && value !== null) {
                                displayValue = JSON.stringify(value);
                            }
                            this.watchedVars[name].element.textContent = displayValue;
                        } catch (e) {
                            this.watchedVars[name].element.textContent = 'Error';
                        }
                    }
                }
            }

            /**
             * 変数監視の更新ループ
             */
            updateWatchLoop() {
                this.updateWatchValues();
                requestAnimationFrame(() => this.updateWatchLoop());
            }

            /**
             * 操作パネルにボタンを追加する
             * @param {string} label - ボタンのラベル
             * @param {Function} callback - ボタンクリック時に実行される関数
             */
            addButton(label, callback) {
                const button = document.createElement('button');
                button.textContent = label;
                button.className = 'w-full px-3 py-2 bg-indigo-500 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-indigo-400 focus:ring-opacity-75 text-sm';
                button.addEventListener('click', callback);
                this.actionPanel.appendChild(button);
            }
        }

        // --- デバッグツールのインスタンス化と設定 ---
        document.addEventListener('DOMContentLoaded', () => {
            // デバッグツールのインスタンスを作成
            const debugTool = new DebugTool();

            // --- ここからデモ用の設定 ---

            // 監視したい変数を設定
            let counter = 0;
            let userProfile = { name: 'Taro', level: 1, active: true };

            debugTool.watch('Counter', () => counter);
            debugTool.watch('User Profile', () => userProfile);
            debugTool.watch('Mouse Position', () => ({ x: mousePos.x, y: mousePos.y }));


            // カスタム操作ボタンを追加
            debugTool.addButton('カウンターをリセット', () => {
                counter = 0;
                console.log('カウンターがリセットされました。');
            });
            debugTool.addButton('ユーザーを非アクティブ化', () => {
                userProfile.active = false;
                // オブジェクトの変更を反映させるために新しいオブジェクトを作成する
                userProfile = { ...userProfile };
                console.warn('ユーザーが非アクティブになりました。');
            });
            debugTool.addButton('テストアラート', () => {
                alert('これはテストアラートです。');
            });


            // --- デモ用のイベントリスナー ---

            // テストログ出力ボタン
            document.getElementById('test-log-btn').addEventListener('click', () => {
                console.log('テストログメッセージです。', { data: 'sample', value: 123 });
            });

            // テストエラー出力ボタン
            document.getElementById('test-error-btn').addEventListener('click', () => {
                console.error('これは意図的なエラーです。');
            });

            // 監視対象の変数を変更するボタン
            document.getElementById('change-var-btn').addEventListener('click', () => {
                counter++;
                userProfile.level++;
                userProfile = { ...userProfile };
            });

            // マウス座標を追跡
            let mousePos = { x: 0, y: 0 };
            document.addEventListener('mousemove', (e) => {
                mousePos.x = e.clientX;
                mousePos.y = e.clientY;
            });

            // 最初のログ
            console.log('デバッグツールが初期化されました。');
        });
    </script>
</body>

</html>